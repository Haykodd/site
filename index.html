<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Clicker</title>
    <!-- Подключаем Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Дополнительные стили */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Темно-серый фон */
            color: #e5e7eb; /* Светло-серый текст */
        }
        .click-target-container {
            width: 300px; /* Фиксированная ширина */
            height: 300px; /* Фиксированная высота */
            border: 2px dashed #4b5563; /* Серая пунктирная рамка */
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1f2937; /* Темно-серый фон */
        }
        .click-target-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        /* Стили для прокручиваемых списков */
        .scrollable-list-container {
            max-height: 250px; /* Ограничение высоты */
            overflow-y: auto; /* Включение вертикальной прокрутки */
            background-color: #1f2937;
            border-radius: 0.5rem;
            padding: 8px;
        }
        /* Стили для скроллбара */
        .scrollable-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-list-container::-webkit-scrollbar-track {
            background: #374151; /* Фон трека */
            border-radius: 4px;
        }
        .scrollable-list-container::-webkit-scrollbar-thumb {
            background: #6b7280; /* Цвет ползунка */
            border-radius: 4px;
        }
        .scrollable-list-container::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; /* Цвет при наведении */
        }
        /* Стили для переключателей */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* Стили для экрана выбора */
        .mode-select-card {
            background-color: #1f2937;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            border: 2px solid #374151;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .mode-select-card:hover {
            border-color: #06b6d4; /* Cyan */
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Скрытие/Отображение секций */
        .hidden-section {
            display: none;
        }
        
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- ЭКРАН ВЫБОРА РЕЖИМА -->
    <div id="modeSelectorScreen" class="max-w-4xl mx-auto text-center">
        <h1 class="text-4xl font-bold text-white mb-8">Выберите Режим Игры</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- Карточка Kraken Clicker -->
            <div id="selectKraken" class="mode-select-card">
                <h2 class="text-3xl font-bold text-cyan-400 mb-4">Kraken Clicker</h2>
                <p class="text-gray-300">
                    Классический режим с дропом фруктов, системой редкостей и переключателями шансов.
                </p>
                <p class="mt-4 text-sm text-gray-500">(Фрукты: Tori, Pika, Mochi...)</p>
            </div>
            
            <!-- Карточка True Ba'al Clicker -->
            <div id="selectBaal" class="mode-select-card">
                <h2 class="text-3xl font-bold text-orange-500 mb-4">True Ba'al Clicker</h2>
                <p class="text-gray-300">
                    Новый режим с дропом редкой экипировки с True Demon Ba'al (шансы 2025).
                </p>
                <p class="mt-4 text-sm text-gray-500">(Дроп: World Ender, Snake Head...)</p>
            </div>
            
        </div>
    </div>

    <!-- ОСНОВНАЯ ИГРА (По умолчанию скрыта) -->
    <div id="gameScreen" class="hidden max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">

        <!-- Левая колонка: Кликер -->
        <div class="md:col-span-2 bg-gray-900 p-6 rounded-lg shadow-lg relative">
            
            <!-- Кнопка смены режима -->
            <button id="resetMode" class="absolute top-4 left-4 bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition duration-200">
                Сменить Режим
            </button>
            
            <h1 id="gameTitle" class="text-3xl font-bold text-center mb-6 text-white">...</h1>
            
            <!-- Загрузчик изображения -->
            <div class="mb-4 text-center">
                <label for="imageUploader" class="cursor-pointer bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Загрузить своё изображение
                </label>
                <input type="file" id="imageUploader" class="hidden" accept="image/*">
            </div>

            <!-- Зона для кликов -->
            <div id="clickTarget" class="click-target-container mx-auto select-none transition-transform duration-75 active:scale-95">
                <span class="text-gray-400">Загрузите изображение для кликов</span>
            </div>
            
            <!-- Счетчик кликов -->
            <div class="mt-6 text-center">
                <p class="text-2xl font-bold text-white">
                    <span id="clickCounter" class="text-cyan-400">0</span> / 1
                </p>
                <p id="clickCounterLabel" class="text-sm text-gray-400">Кликов до убийства</p>
            </div>
        </div>

        <!-- Правая колонка: Дроп -->
        <div class="md:col-span-1 bg-gray-900 p-6 rounded-lg shadow-lg space-y-6">
            
            <!-- Статистика -->
            <div>
                <h2 class="text-2xl font-bold text-center mb-4 text-white">Статистика</h2>
                <div class="bg-gray-800 p-4 rounded-lg text-center">
                    <p id="killCounterLabel" class="text-lg text-gray-300">Убито...</p>
                    <p id="casesOpened" class="text-4xl font-bold text-white">0</p>
                </div>
            </div>

            <!-- Последний дроп -->
            <div>
                <h2 class="text-2xl font-bold text-center mb-4 text-white">Последний дроп</h2>
                <div id="lastDrop" class="bg-gray-800 p-4 rounded-lg text-center min-h-[50px]">
                    <p id="lastDropDefaultText" class="text-gray-400">Нажми 1 раз...</p>
                </div>
            </div>

            <!-- История дропа (подряд) -->
            <div>
                <h2 class="text-2xl font-bold text-center mb-4 text-white">История дропа</h2>
                <div id="dropListContainer" class="scrollable-list-container bg-gray-800 p-2 rounded-lg min-h-[100px]">
                    <ul id="dropList" class="divide-y divide-gray-700">
                        <!-- Элементы дропа будут добавлены сюда -->
                    </ul>
                </div>
            </div>
            
            <!-- Коллекция Фруктов (только для Кракена) -->
            <div id="fruitCollectionSection" class="hidden-section">
                <h2 class="text-2xl font-bold text-center mb-4 text-white">Коллекция Фруктов</h2>
                <div id="fruitCollectionContainer" class="scrollable-list-container bg-gray-800 p-2 rounded-lg min-h-[100px]">
                    <ul id="fruitCollectionList" class="divide-y divide-gray-700">
                        <!-- Элементы коллекции фруктов будут добавлены сюда -->
                    </ul>
                </div>
            </div>


            <!-- Шансы (Контейнер) -->
            <div>
                <h2 id="dropChanceTitle" class="text-2xl font-bold text-center mb-4 text-white">Шансы выпадения</h2>
                
                <!-- Шансы для Кракена (только для Кракена) -->
                <div id="krakenChanceSection" class="hidden-section bg-gray-800 p-4 rounded-lg">
                    <ul class="space-y-1 text-md">
                        <li class="flex justify-between"><span>Book of Spirits</span> <span class="font-bold text-yellow-400">45%</span></li>
                        <li class="flex justify-between"><span>Mysterious Book</span> <span class="font-bold text-yellow-400">15%</span></li>
                        <li class="flex justify-between"><span>Kraken Cape</span> <span class="font-bold text-yellow-400">5%</span></li>
                        <li class="flex justify-between"><span>Kraken Armor</span> <span class="font-bold text-red-500">1%</span></li>
                        <li class="flex justify-between"><span>Kraken Blade</span> <span class="font-bold text-red-500">1%</span></li>
                        <li class="flex justify-between"><span>Kraken Katana</span> <span class="font-bold text-red-500">1%</span></li>
                        <li class="flex justify-between"><span>Kraken Core</span> <span class="font-bold text-red-500">1%</span></li>
                        <li class="flex justify-between"><span>(Ничего)</span> <span class="font-bold text-gray-400">30%</span></li>
                        
                        <!-- Переключатель Great Kraken (100% Фрукт) -->
                        <li class="flex justify-between items-center pt-2 mt-2 border-t border-gray-700">
                            <div class="flex flex-col">
                                <span>Devil Fruit</span>
                                <span class="text-xs text-green-400">(Вкл. 100% Фрукт)</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleGreatKraken" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            </label>
                        </li>
                        <li class="flex justify-between text-sm text-gray-400"><span>(Базовый шанс Fruit)</span> <span class="font-bold text-red-500">1%</span></li>
                    </ul>
                </div>
                
                <!-- Шансы Дьявольских Фруктов (только для Кракена) -->
                <div id="fruitChanceSection" class="hidden-section mt-6 pt-4 border-t border-gray-600 bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-xl font-semibold text-center mb-3">Шансы Devil Fruit</h3>
                    
                    <!-- Переключатели ASE и Logia -->
                    <div class="flex flex-wrap justify-center gap-x-6 gap-y-2 mb-4">
                        <!-- Переключатель ASE -->
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggleASE" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                            <span class="ml-3 text-sm font-medium text-gray-300">ASE</span>
                        </label>
                        <!-- Переключатель 2x Logia -->
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggleLogia" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                            <span class="ml-3 text-sm font-medium text-gray-300">2x Logia</span>
                        </label>
                    </div>
                    
                    <ul class="space-y-1 text-md">
                        <li class="flex justify-between"><span>Common</span> <span id="fruitCommonChance" class="font-bold text-white">59.5%</span></li>
                        <li class="flex justify-between"><span>Rare</span> <span id="fruitRareChance" class="font-bold text-blue-400">26%</span></li>
                        <li class="flex justify-between"><span>Epic</span> <span id="fruitEpicChance" class="font-bold text-purple-400">10%</span></li>
                        <li class="flex justify-between"><span>Legendary</span> <span id="fruitLegendaryChance" class="font-bold text-yellow-400">4%</span></li>
                        <li class="flex justify-between"><span>Mythical</span> <span id="fruitMythicalChance" class="font-bold text-red-500">0.5%</span></li>
                    </ul>
                </div>
                
                <!-- Шансы для Баала (только для Баала) -->
                <div id="baalChanceSection" class="hidden-section bg-gray-800 p-4 rounded-lg">
                    <ul class="space-y-1 text-md">
                        <!-- Шансы 2025 -->
                        <li class="flex justify-between"><span>True Ba'al's Snake Fire</span> <span class="font-bold text-yellow-400">20%</span></li>
                        <li class="flex justify-between"><span>True Ba'al's Snake Head</span> <span class="font-bold text-purple-400">5%</span></li>
                        <li class="flex justify-between"><span>True Ba'al's Horns</span> <span class="font-bold text-purple-400">5%</span></li>
                        <li class="flex justify-between"><span>True Ba'al's Guard</span> <span class="font-bold text-purple-400">2%</span></li>
                        <li class="flex justify-between"><span>Hollow's Great Sword</span> <span class="font-bold text-purple-400">2%</span></li>
                        <li class="flex justify-between"><span>Hollow's World Ender</span> <span class="font-bold text-red-500">~1%</span></li>
                        <li class="flex justify-between"><span>Endbringer Wings</span> <span class="font-bold text-red-500">1%</span></li>
                        <li class="flex justify-between"><span>Endbringer Armor</span> <span class="font-bold text-red-500">1%</span></li>
                        <li class="flex justify-between"><span>Prestige World Ender</span> <span class="font-bold text-red-500">~0.001%</span></li>
                        <!-- Рассчитанный шанс "Ничего" -->
                        <li class="flex justify-between"><span>(Ничего)</span> <span class="font-bold text-gray-400">~62.999%</span></li>
                    </ul>
                </div>
                
            </div>
        </div>

    </div>

    <script>
        // ===========================================
        // DOM Элементы
        // ===========================================
        
        // Экраны
        const modeSelectorScreen = document.getElementById('modeSelectorScreen');
        const gameScreen = document.getElementById('gameScreen');
        
        // Кнопки выбора
        const selectKraken = document.getElementById('selectKraken');
        const selectBaal = document.getElementById('selectBaal');
        const resetMode = document.getElementById('resetMode');
        
        // Элементы игры
        const gameTitle = document.getElementById('gameTitle');
        const clickTarget = document.getElementById('clickTarget');
        const imageUploader = document.getElementById('imageUploader');
        const clickCounterEl = document.getElementById('clickCounter');
        const casesOpenedEl = document.getElementById('casesOpened');
        const lastDropEl = document.getElementById('lastDrop');
        const dropList = document.getElementById('dropList');
        const dropListContainer = document.getElementById('dropListContainer');
        const killCounterLabel = document.getElementById('killCounterLabel');
        const lastDropDefaultText = document.getElementById('lastDropDefaultText');
        
        // Секции (для скрытия/отображения)
        const fruitCollectionSection = document.getElementById('fruitCollectionSection');
        const krakenChanceSection = document.getElementById('krakenChanceSection');
        const fruitChanceSection = document.getElementById('fruitChanceSection');
        const baalChanceSection = document.getElementById('baalChanceSection');
        
        // Элементы коллекции фруктов
        const fruitCollectionList = document.getElementById('fruitCollectionList'); 
        
        // Элементы переключателей (Кракен)
        const toggleASE = document.getElementById('toggleASE');
        const toggleLogia = document.getElementById('toggleLogia');
        const toggleGreatKraken = document.getElementById('toggleGreatKraken');
        const fruitCommonChanceEl = document.getElementById('fruitCommonChance');
        const fruitRareChanceEl = document.getElementById('fruitRareChance');
        const fruitEpicChanceEl = document.getElementById('fruitEpicChance');
        const fruitLegendaryChanceEl = document.getElementById('fruitLegendaryChance');
        const fruitMythicalChanceEl = document.getElementById('fruitMythicalChance');

        // ===========================================
        // Состояние Игры
        // ===========================================
        
        let currentGameMode = null; // 'kraken' или 'baal'
        let clickCount = 0;
        let casesOpened = 0;
        
        // Для "Истории дропа" (подряд)
        let lastDroppedItemName = null;
        let lastDropListItem = null;
        let lastDropCount = 0;
        
        // Для "Коллекции фруктов" (общее)
        let fruitCollection = {}; // { "Pika": 2, "Spin": 5 }

        // Состояние переключателей (Кракен)
        let isASEActive = false;
        let isLogiaActive = false;
        let isGreatKrakenActive = false; 

        // ===========================================
        // Базы Данных Дропа и Цветов
        // ===========================================

        // ---------------------------------
        // КРАКЕН: Списки Фруктов
        // ---------------------------------
        const fruitListsByRarity = {
            Mythical: ["Tori", "Mochi", "Ope", "Venom", "Buddha", "Pteranodon"],
            Legendary: ["Mera", "Pika", "Hie", "Magu", "Goro", "Gura", "Zushi", "Suna", "Ito", "Paw", "Kage", "Yami", "Goru", "Smoke"],
            Epic: ["Yomi", "Spring", "Kira"],
            Rare: ["Bari", "Mero", "Horo", "Gomu", "Bomu"],
            Common: ["Suke", "Kilo", "Spin", "Heal"]
        };

        // ---------------------------------
        // КРАКЕН: Шансы Дропа
        // ---------------------------------
        const krakenRewards = [
            { name: "Book of Spirits", chance: 45 },
            { name: "Mysterious Book", chance: 15 },
            { name: "Kraken Cape", chance: 5 },
            { name: "Kraken Armor", chance: 1 },
            { name: "Kraken Blade", chance: 1 },
            { name: "Kraken Katana", chance: 1 },
            { name: "Kraken Core", chance: 1 },
            { name: "Devil Fruit", chance: 1 }, // Это запускает второй ролл
            { name: "Ничего", chance: 30 } // 100 - (45+15+5+1+1+1+1+1) = 30
        ];

        // ---------------------------------
        // КРАКЕН: Шансы Редкости Фруктов
        // ---------------------------------
        const fruitRarityChances = {
            none: [
                { name: "Common", chance: 59.5 },
                { name: "Rare", chance: 26 },
                { name: "Epic", chance: 10 },
                { name: "Legendary", chance: 4 },
                { name: "Mythical", chance: 0.5 }
            ],
            oneActive: [ // ASE *ИЛИ* Logia
                { name: "Common", chance: 54 },
                { name: "Rare", chance: 26 },
                { name: "Epic", chance: 10 },
                { name: "Legendary", chance: 8 },
                { name: "Mythical", chance: 1 }
            ],
            bothActive: [ // ASE *И* Logia
                { name: "Common", chance: 44 },
                { name: "Rare", chance: 26 },
                { name: "Epic", chance: 10 },
                { name: "Legendary", chance: 16 },
                { name: "Mythical", chance: 2 }
            ]
        };
        
        // ---------------------------------
        // БААЛ: Шансы Дропа (2025)
        // ---------------------------------
        // True Ba'al's Guard (2%)
        // Hollow's Great Sword (2%)
        // True Ba'al's Snake Head (5%)
        // True Ba'al's Snake Fire (20%)
        // True Ba'al's Horns (5%)
        // Hollow's World Ender (~1%) -> 1%
        // Prestige World Ender (~0.001%) -> 0.001%
        // Endbringer Wings (1%)
        // Endbringer Armor (1%)
        // Сумма: 20 + 5 + 5 + 2 + 2 + 1 + 1 + 1 + 0.001 = 37.001%
        // Ничего: 100 - 37.001 = 62.999%
        const baalRewards = [
            { name: "True Ba'al's Snake Fire", chance: 20 },
            { name: "True Ba'al's Snake Head", chance: 5 },
            { name: "True Ba'al's Horns", chance: 5 },
            { name: "True Ba'al's Guard", chance: 2 },
            { name: "Hollow's Great Sword", chance: 2 },
            { name: "Hollow's World Ender", chance: 1 },
            { name: "Endbringer Wings", chance: 1 },
            { name: "Endbringer Armor", chance: 1 },
            { name: "Prestige World Ender", chance: 0.001 },
            { name: "Ничего", chance: 62.999 }
        ];

        // ---------------------------------
        // ОБЩИЕ ЦВЕТА
        // ---------------------------------
        const rarityColors = {
            "default": "text-gray-300",
            // Кракен: Обычные дропы
            "Book of Spirits": "text-yellow-400",
            "Mysterious Book": "text-yellow-400",
            "Kraken Cape": "text-yellow-400",
            "Kraken Armor": "text-red-500",
            "Kraken Blade": "text-red-500",
            "Kraken Katana": "text-red-500",
            "Kraken Core": "text-red-500",
            // Кракен: Редкости Фруктов
            "Common": "text-white",
            "Rare": "text-blue-400",
            "Epic": "text-purple-400",
            "Legendary": "text-yellow-400",
            "Mythical": "text-red-500",
            // Баал: Редкости Дропа
            "True Ba'al's Snake Fire": "text-yellow-400", // 20% - Легендарный
            "True Ba'al's Snake Head": "text-purple-400", // 5% - Эпик
            "True Ba'al's Horns": "text-purple-400", // 5% - Эпик
            "True Ba'al's Guard": "text-purple-400", // 2% - Эпик
            "Hollow's Great Sword": "text-purple-400", // 2% - Эпик
            "Hollow's World Ender": "text-red-500", // 1% - Мифик
            "Endbringer Wings": "text-red-500", // 1% - Мифик
            "Endbringer Armor": "text-red-500", // 1% - Мифик
            "Prestige World Ender": "text-red-500" // 0.001% - Мифик (но сделаем ярче)
        };
        
        // ===========================================
        // Игровые Функции
        // ===========================================

        // Найти редкость фрукта по имени (для цвета и коллекции)
        function getRarityByFruitName(fruitName) {
            for (const rarity in fruitListsByRarity) {
                if (fruitListsByRarity[rarity].includes(fruitName)) {
                    return rarity; // "Mythical", "Legendary" и т.д.
                }
            }
            return null; // Для предметов типа "Kraken Armor"
        }

        // Получить цвет для любого предмета
        function getColorForItem(itemName) {
            // Сначала проверяем прямые совпадения (включая дропы Баала)
            if (rarityColors[itemName]) {
                return rarityColors[itemName];
            }
            //_Теперь_ проверяем, фрукт ли это (только для Кракена)
            const rarity = getRarityByFruitName(itemName); // e.g., "Legendary"
            if (rarity && rarityColors[rarity]) {
                return rarityColors[rarity]; // e.g., "text-yellow-400"
            }
            // Цвет по умолчанию
            return rarityColors["default"];
        }

        // ---------------------------------
        // КРАКЕН: Логика Дропа
        // ---------------------------------
        
        // Получить КОНКРЕТНЫЙ фрукт
        function getFruitRarity() {
            let currentChances;
            if (isASEActive && isLogiaActive) currentChances = fruitRarityChances.bothActive;
            else if (isASEActive || isLogiaActive) currentChances = fruitRarityChances.oneActive;
            else currentChances = fruitRarityChances.none;

            const rand = Math.random() * 100;
            let cumulativeChance = 0;
            let chosenRarity = "Common"; 

            for (const item of currentChances) {
                cumulativeChance += item.chance;
                if (rand < cumulativeChance) {
                    chosenRarity = item.name; // "Mythical", "Legendary", "Epic" и т.д.
                    break;
                }
            }
            const fruitList = fruitListsByRarity[chosenRarity];
            const randomIndex = Math.floor(Math.random() * fruitList.length);
            return fruitList[randomIndex]; // "Pika", "Tori", "Spin" и т.д.
        }

        // Получить награду с КРАКЕНА
        function getKrakenReward() {
            if (isGreatKrakenActive) {
                return getFruitRarity(); // 100% фрукт
            }

            const rand = Math.random() * 100;
            let cumulativeChance = 0;
            for (const item of krakenRewards) {
                cumulativeChance += item.chance;
                if (rand < cumulativeChance) {
                    if (item.name === "Devil Fruit") {
                        return getFruitRarity(); // Ролл на фрукт
                    }
                    return item.name; 
                }
            }
            return "Ничего";
        }
        
        // ---------------------------------
        // БААЛ: Логика Дропа
        // ---------------------------------
        function getBaalReward() {
            const rand = Math.random() * 100;
            let cumulativeChance = 0;
            for (const item of baalRewards) {
                cumulativeChance += item.chance;
                if (rand < cumulativeChance) {
                    return item.name; 
                }
            }
            return "Ничего";
        }

        // ---------------------------------
        // Общая Функция Дропа
        // ---------------------------------
        function getRandomReward() {
            if (currentGameMode === 'kraken') {
                return getKrakenReward();
            } else if (currentGameMode === 'baal') {
                return getBaalReward();
            }
            return "Ошибка"; // Такого не должно быть
        }
        
        // ---------------------------------
        // ОБНОВЛЕНИЕ UI
        // ---------------------------------

        // Обновить UI шансов (только для Кракена)
        function updateFruitChanceUI() {
            if (isASEActive && isLogiaActive) {
                // Оба включены
                fruitCommonChanceEl.textContent = "44%";
                fruitLegendaryChanceEl.textContent = "16%";
                fruitMythicalChanceEl.textContent = "2%";
                fruitCommonChanceEl.parentElement.classList.remove('text-white');
                fruitLegendaryChanceEl.parentElement.classList.remove('text-yellow-400');
                fruitMythicalChanceEl.parentElement.classList.remove('text-red-500');
                fruitCommonChanceEl.parentElement.classList.add('text-white');
                fruitLegendaryChanceEl.parentElement.classList.add('text-yellow-400');
                fruitMythicalChanceEl.parentElement.classList.add('text-red-500');

            } else if (isASEActive || isLogiaActive) {
                // Один включен
                fruitCommonChanceEl.textContent = "54%";
                fruitLegendaryChanceEl.textContent = "8%";
                fruitMythicalChanceEl.textContent = "1%";
                fruitCommonChanceEl.parentElement.classList.remove('text-white');
                fruitLegendaryChanceEl.parentElement.classList.remove('text-yellow-400');
                fruitMythicalChanceEl.parentElement.classList.remove('text-red-500');
                fruitCommonChanceEl.parentElement.classList.add('text-white');
                fruitLegendaryChanceEl.parentElement.classList.add('text-yellow-400');
                fruitMythicalChanceEl.parentElement.classList.add('text-red-500');
            } else {
                // Оба выключены
                fruitCommonChanceEl.textContent = "59.5%";
                fruitLegendaryChanceEl.textContent = "4%";
                fruitMythicalChanceEl.textContent = "0.5%";
                fruitCommonChanceEl.parentElement.classList.remove('text-white');
                fruitLegendaryChanceEl.parentElement.classList.remove('text-yellow-400');
                fruitMythicalChanceEl.parentElement.classList.remove('text-red-500');
                fruitCommonChanceEl.parentElement.classList.add('text-white');
                fruitLegendaryChanceEl.parentElement.classList.add('text-yellow-400');
                fruitMythicalChanceEl.parentElement.classList.add('text-red-500');
            }
             // Обновляем неизменяемые шансы
            fruitRareChanceEl.textContent = "26%";
            fruitEpicChanceEl.textContent = "10%";
        }

        // Отобразить награду
        function displayReward(itemName) {
            const color = getColorForItem(itemName);
            
            // "Prestige World Ender" - особый цвет
            const finalColor = itemName === "Prestige World Ender" ? "text-red-500 animate-pulse" : color;
            
            // Обновляем "Последний дроп"
            lastDropEl.innerHTML = `<p class="font-bold ${finalColor}">${itemName}</p>`;

            // Добавляем в историю (подряд), только если это не "Ничего"
            if (itemName !== "Ничего") {
                if (lastDroppedItemName === itemName && lastDropListItem) {
                    // Увеличиваем счетчик (подряд)
                    lastDropCount++;
                    lastDropListItem.innerHTML = `<span class="${finalColor}">${itemName}</span> <span class="text-gray-400 text-sm">x${lastDropCount}</span>`;
                } else {
                    // Сбрасываем счетчик (подряд) и создаем новый элемент
                    lastDroppedItemName = itemName;
                    lastDropCount = 1;
                    
                    const listItem = document.createElement('li');
                    listItem.className = `p-2 ${finalColor} font-semibold flex justify-between`;
                    listItem.innerHTML = `<span>${itemName}</span>`;
                    dropList.prepend(listItem);
                    lastDropListItem = listItem;
                }
                dropListContainer.scrollTop = 0;
            }
            
            // Обновляем "Коллекцию Фруктов" (только для Кракена)
            if (currentGameMode === 'kraken') {
                const fruitRarity = getRarityByFruitName(itemName);
                if (fruitRarity) { // Если это фрукт (Common, Rare, и т.д.)
                    fruitCollection[itemName] = (fruitCollection[itemName] || 0) + 1;
                    
                    let fruitItemEl = document.getElementById(`fruit-${itemName}`);
                    
                    if (fruitItemEl) {
                        fruitItemEl.innerHTML = `<span>${itemName}</span> <span class="text-gray-400 text-sm">x${fruitCollection[itemName]}</span>`;
                    } else {
                        fruitItemEl = document.createElement('li');
                        fruitItemEl.id = `fruit-${itemName}`; 
                        fruitItemEl.className = `p-2 ${color} font-semibold flex justify-between`;
                        fruitItemEl.innerHTML = `<span>${itemName}</span> <span class="text-gray-400 text-sm">x1</span>`;
                        fruitCollectionList.prepend(fruitItemEl); 
                    }
                }
            }
        }
        
        // ---------------------------------
        // ИНИЦИАЛИЗАЦИЯ
        // ---------------------------------
        
        // Сброс и очистка состояния (для смены режима)
        function resetGameState() {
            clickCount = 0;
            casesOpened = 0;
            lastDroppedItemName = null;
            lastDropListItem = null;
            lastDropCount = 0;
            fruitCollection = {};
            isASEActive = false;
            isLogiaActive = false;
            isGreatKrakenActive = false;
            
            // Сброс UI
            clickCounterEl.textContent = "0";
            casesOpenedEl.textContent = "0";
            dropList.innerHTML = "";
            fruitCollectionList.innerHTML = "";
            lastDropEl.innerHTML = `<p class="text-gray-400">${lastDropDefaultText.textContent}</p>`;
            
            // Сброс переключателей
            toggleASE.checked = false;
            toggleLogia.checked = false;
            toggleGreatKraken.checked = false;
        }

        // Запуск Игры (Вызывается при выборе режима)
        function startGame(mode) {
            currentGameMode = mode;
            
            // Сбрасываем состояние
            resetGameState();
            
            // Настраиваем UI под режим
            if (mode === 'kraken') {
                gameTitle.textContent = "Kraken Clicker";
                gameTitle.className = "text-3xl font-bold text-center mb-6 text-cyan-400";
                killCounterLabel.textContent = "Убито кракенов";
                lastDropDefaultText.textContent = "Нажми 1 раз на кракена...";
                
                // Показываем секции Кракена
                fruitCollectionSection.style.display = 'block';
                krakenChanceSection.style.display = 'block';
                fruitChanceSection.style.display = 'block';
                baalChanceSection.style.display = 'none';
                
                // Обновляем UI шансов (на случай, если он не по умолчанию)
                updateFruitChanceUI();
                
            } else if (mode === 'baal') {
                gameTitle.textContent = "True Ba'al Clicker";
                gameTitle.className = "text-3xl font-bold text-center mb-6 text-orange-500";
                killCounterLabel.textContent = "Убито Баалов";
                lastDropDefaultText.textContent = "Нажми 1 раз на Баала...";
                
                // Скрываем секции Кракена
                fruitCollectionSection.style.display = 'none';
                krakenChanceSection.style.display = 'none';
                fruitChanceSection.style.display = 'none';
                baalChanceSection.style.display = 'block';
            }
            
            // Обновляем текст "Последний дроп"
            lastDropEl.innerHTML = `<p class="text-gray-400">${lastDropDefaultText.textContent}</p>`;

            // Переключаем экраны
            modeSelectorScreen.style.display = 'none';
            gameScreen.style.display = 'grid'; // Используем grid
        }

        // ===========================================
        // Обработчики Событий
        // ===========================================

        // Выбор режима
        selectKraken.addEventListener('click', () => startGame('kraken'));
        selectBaal.addEventListener('click', () => startGame('baal'));
        
        // Кнопка Сброса
        resetMode.addEventListener('click', () => {
            // Просто перезагружаем страницу - это самый простой способ все сбросить
            window.location.reload();
        });

        // Загрузка изображения
        imageUploader.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    clickTarget.innerHTML = ''; // Очищаем плейсхолдер
                    clickTarget.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });

        // Главный обработчик кликов
        clickTarget.addEventListener('click', () => {
            if (!clickTarget.querySelector('img')) {
                lastDropEl.innerHTML = `<p class="font-bold text-red-500">Сначала загрузите изображение!</p>`;
                return; 
            }
            
            clickCount++;

            if (clickCount >= 1) { // 1 клик
                const reward = getRandomReward();
                displayReward(reward);
                
                casesOpened++;
                casesOpenedEl.textContent = casesOpened;
                
                clickCount = 0;
            }
            clickCounterEl.textContent = clickCount;
        });

        // Обработчики переключателей (Кракена)
        toggleASE.addEventListener('change', (event) => {
            isASEActive = event.target.checked;
            updateFruitChanceUI(); 
        });

        toggleLogia.addEventListener('change', (event) => {
            isLogiaActive = event.target.checked;
            updateFruitChanceUI(); 
        });

        toggleGreatKraken.addEventListener('change', (event) => {
            isGreatKrakenActive = event.target.checked;
        });

    </script>

</body>
</html>



